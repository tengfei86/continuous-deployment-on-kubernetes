<html>

<head>
    <script>

    var grantType    = "password";
    var clientId     = "Dspdm_Privilege_QA";
    var clientSecret = "2a9d2ad1-9d7b-462f-819b-f6e3334499d5";
    var kc_username = "pdm";
    var kc_password = "pdm";
    var keycloakURL  = "https://dssecurity.tiger4.dazlmkengdev01.landmarksoftware.cloud/auth/realms/DecisionSpace_Integration_Server/protocol/openid-connect/token";
    var keycloakTokenRequestData = "grant_type=" + grantType
            + "&client_id=" + clientId
            + "&client_secret=" + clientSecret
            + "&username=" + kc_username
            + "&password=" + kc_password;

        backendAPIRootUrl = "https://tiger4.dazlmkengdev01.landmarksoftware.cloud/services/qa-dspdmservice/msp";
        // backendAPIRootUrl = "https://tiger4.dazlmkengdev01.landmarksoftware.cloud/services/dspdmservice/msp";
        privilegeServiceGetTokenUrl = "https://tiger4.dazlmkengdev01.landmarksoftware.cloud/services/qa-privilegeservice/msp/auth/token"
        privilegeServiceGetTokenData = {
            "keycloakServerURL":"https://conf.tiger4.dazlmkengdev01.landmarksoftware.cloud/dssecurity/api/token",
            "keycloakRealmName":"DecisionSpace_Integration_Server",
            "keycloakClientName":"Dspdm_Privilege_Demo",
            "username":"pdm",
            "userPass":"pdm"
        };
        useDirectTokenURL = true
        // ajax object
        function ajaxObject() {
            var xmlHttp;
            try {
                // Firefox, Opera 8.0+, Safari
                xmlHttp = new XMLHttpRequest();
            }
            catch (e) {
                // Internet Explorer
                try {
                    xmlHttp = new ActiveXObject("Msxml2.XMLHTTP");
                } catch (e) {
                    try {
                        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
                    } catch (e) {
                        alert("Your browser does not support AJAX！");
                        return false;
                    }
                }
            }
            return xmlHttp;
        }
        //get token from keycloak from privilege service or direct url
        function getTokenFromKeycloak(getTokenData,fnResponse, fnLoading) {
            var ajax = ajaxObject();
            ajax.open("post", keycloakURL, true);
            // ajax.setRequestHeader("Content-Type", "application/json");
            ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            ajax.onreadystatechange = function () {
                if (ajax.readyState == 4) {
                    fnResponse(ajax.status, ajax.responseText);
                } else {
                    fnLoading();
                }
            }
            ajax.send(getTokenData);
        }
        // ajax post：
        function ajaxPost(url, data, token, fnResponse, fnLoading) {
            if(_apiUrl == "/secure/export") {
                ajaxPostExport(url,data,token,fnResponse,fnLoading);
                return;
            }
            var ajax = ajaxObject();
            ajax.open("post", url, true);
            ajax.setRequestHeader("Content-Type", "application/json");
            ajax.setRequestHeader("Authorization", "Bearer " + token);
            ajax.onreadystatechange = function () {
                if (ajax.readyState == 4) {
                    fnResponse(ajax.status, ajax.responseText);
                } else {
                    fnLoading();
                }
            }
            ajax.send(data);
        }
        // ajax post export：
        function ajaxPostExport(url, data, token, fnResponse, fnLoading) {
            var ajax = ajaxObject();
            ajax.open("post", url, true);
            ajax.responseType = "blob";
            ajax.setRequestHeader("Content-Type", "application/json");
            ajax.setRequestHeader("Authorization", "Bearer " + token);
            ajax.onreadystatechange = function () {
                if (ajax.readyState == 4) {
                    var fileName;
                    if (ajax.status == 200) {
                        fileName = "dspdm_export.xlsx";
                        downloadBlob(ajax.response, fileName);
                        fnResponse(ajax.status, "Exported to excel file:" + fileName);
                    } else {
                        fileName = "dspdm_export_error.json";
                        downloadBlob(ajax.response, fileName);
                        fnResponse(ajax.status, "Could not export correctly, please check the file:" + fileName);
                    }
                } else {
                    fnLoading();
                }
            }
            ajax.send(data);
        }

        function downloadBlob(responseData, fileName) {
            var excelBlob = new Blob([responseData], { type: 'application/octet-stream' });
            if (isIE()) {
                window.navigator.msSaveOrOpenBlob(excelBlob, fileName);
            } else {
                var a = document.getElementById("exportbtn");
                a.href = URL.createObjectURL(excelBlob);
                a.download = fileName;
                a.click();
                a.href = "";
            }
        }

        function isIE() {
            if (!!window.ActiveXObject || "ActiveXObject" in window) {
                return true;
            } else {
                return false;
            }
        }

        _apiUrl = "/secure/common";
        function postCommon() {
            if (_apiUrl == keycloakURL) {
                //only get token
                var getTokenData = document.getElementById("reqBody").value;
                getTokenFromKeycloak(getTokenData,function tokenResponse(tokenStatus, tokenData) {
                    document.getElementById("resBody").value = tokenStatus + "\r\n" + tokenData;
                }, function tokenLoading() {
                    document.getElementById("resBody").value = "get token...";
                });
            } else {
                //get token from keycloak
                getTokenFromKeycloak(keycloakTokenRequestData,function tokenResponse(tokenStatus, tokenData) {
                    if (tokenStatus == 200) {
                        var token = JSON.parse(tokenData).access_token;
                        //send request API
                        var url = backendAPIRootUrl + _apiUrl;
                        var data = document.getElementById("reqBody").value;
                        ajaxPost(url, data, token, function response(status, text) {
                            document.getElementById("resBody").value = status + "\r\n" + text;
                        }, function loading() {
                            document.getElementById("resBody").value = "loading...";
                        });
                    } else {
                        document.getElementById("resBody").value = "get token failed:" + tokenStatus;
                    }
                }, function tokenLoading() {
                    document.getElementById("resBody").value = "get token...";
                });
            }
        }
        function setCommonParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/common";
        }
        function setSaveParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/save";
        }
        function setDeleteParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/delete";
        }
        function setExportParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/export";
        }
        function setImportParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/parse/bulk";
        }
        function setSearchParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/search";
        }
        function setSearchSingleParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/search";
        }
        function setSearchAllParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/searchAll";
        }
        function setSearchIndexAllParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/search/indexAll";
        }
        function setSearchClearIndexParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/secure/search/indexAll";
        }
        function setGenerateMetadata(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/generateMetadataForExistingTable";
        }
        function setGenerateMetadataForAll(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/generateMetadataForAll";
        }
        function setDeleteMetadata(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/deleteMetadata";
        }
        function setIntroduceNewBusinessObjectsParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/introduceNewBusinessObjects";
        }
        function setDropBusinessObjectsParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/dropBusinessObjects";
        }
        function setAddRelationshipsParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/addRelationships";
        }
        function setDropRelationshipsParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/dropRelationships";
        }
        function setAddUniqueConstraintsParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/addUniqueConstraints";
        }
        function setAddBusinessGroupParams(reqBody) {
			//new API
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/addBusinessObjectGroups";
        }     
       function setDropBusinessGroupParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/DropBusinessObjectGroups";
        }
        function setDropUniqueConstraintsParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/dropUniqueConstraints";
        }
        function setGetTokenParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = keycloakURL;
        }
        function setAddCustomAttribute(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/addCustomAttributes";
        }
		function setUpdateCustomAttribute(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/updateCustomAttributes";
        }
        function setDeleteCustomAttribute(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/metadata/write/deleteCustomAttributes";
        }
		function setValidateMetadataForSingleTableParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/config/validateMetadata/FORMATION";
        }
		function setValidateMetadataForAllTableParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/config/validateMetadata";
        }
		function setValidateMetadataForAllTableAndRefreshParams(reqBody) {
            document.getElementById("reqBody").value = reqBody;
            _apiUrl = "/config/validateAndRefreshMetadata";
        }
    </script>
    <link rel="stylesheet" href="invokeApi.css" type="text/css" />
</head>

<body>
    <!-- Request body -->
    <h5 class="title">Request body:</h5>
    <textarea id="reqBody" rows="12" cols="75">

    </textarea>

    <!-- Invoke -->
    <button onclick="postCommon()" id="btnInvoke">Try it out!</button>
    <a id="exportbtn"></a>

    <!-- Response body -->
    <h5 class="title">Response body:</h5>
    <textarea id="resBody" rows="18" cols="75">

    </textarea>

    <!-- script -->
    <!-- <script src="../resources/invokeAPI.js">
    </script> -->
</body>

</html>